<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Flink Live Metrics Dashboard</title>
    <!-- Load Tailwind CSS for aesthetics -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'flink-blue': '#4c78a0',
                        'bg-dark': '#111827',
                        'card-bg': '#1f2937'
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    <style>
        /* General styling */
        body {
            font-family: 'Inter', sans-serif;
        }
    </style>
</head>
<body class="bg-bg-dark text-gray-100 min-h-screen p-4 sm:p-8">

<div class="max-w-7xl mx-auto">
    <header class="text-center mb-10 pb-4 border-b border-gray-700">
        <h1 class="text-4xl font-extrabold text-white mb-2 tracking-tight">
            <span class="text-flink-blue">Flink</span> Live Streaming Dashboard
        </h1>
        <p class="text-gray-400 text-sm">Monitoring via Spring Boot WebSocket Backend (ws://localhost:8080/metrics-feed)</p>
        <div id="status" class="mt-4 p-2 rounded-lg text-sm font-semibold transition-all duration-300">
            Connecting to WebSocket Backend...
        </div>
    </header>

    <div id="metrics-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
        <!-- Metric Cards will be inserted here -->
    </div>

    <div class="mt-10">
        <h2 class="text-xl font-semibold mb-3 text-gray-300">Architecture Note & Live Log</h2>
        <div class="bg-card-bg p-4 rounded-lg mb-4 text-xs text-gray-400 border border-gray-700">
            <p class="font-bold text-gray-200 mb-1">Architecture Note (WebSocket Proxy):</p>
            <p>This frontend connects to the **Spring Boot Backend** via a WebSocket (STOMP protocol) at <code>ws://localhost:8080/metrics-feed</code>. The backend handles the scheduled queries to Prometheus and pushes updates in real-time to this dashboard, fulfilling the secure, decoupled architecture.</p>
        </div>
        <pre id="log" class="bg-gray-800 p-4 rounded-lg text-xs text-gray-300 overflow-x-auto h-48 border border-gray-700"></pre>
    </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.5.1/sockjs.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>

<script>
    // ======================================================================================
    // 1. CONFIGURATION
    // ======================================================================================
    // IMPORTANT: These must match your Spring Boot WebSocket configuration
    const WEBSOCKET_ENDPOINT = 'http://localhost:8088/metrics-feed'; // Spring Boot endpoint
    const SUBSCRIPTION_TOPIC = '/topic/metrics'; // Topic published by MetricsService.java

    const METRICS_CONFIG = [
        {
            id: 'input_rate',
            title: 'Input Rate (All Tasks)',
            unit: 'records/sec',
            initialValue: 'Waiting for feed...'
        },
        {
            id: 'output_rate',
            title: 'Output Rate (All Sinks)',
            unit: 'records/sec',
            initialValue: 'Waiting for feed...'
        },
        {
            id: 'checkpoint_size',
            title: 'Latest Checkpoint Size',
            unit: 'MB',
            initialValue: 'Waiting for feed...'
        }
    ];

    // ======================================================================================
    // 2. LOGGING AND UTILITIES
    // ======================================================================================

    const logElement = document.getElementById('log');

    const log = (message, type = 'info') => {
        const timestamp = new Date().toLocaleTimeString();
        const prefix = type === 'error' ? 'ERROR' : (type === 'warn' ? 'WARN' : 'INFO');
        logElement.textContent += `[${timestamp}] [${prefix}] ${message}\n`;
        logElement.scrollTop = logElement.scrollHeight;
    }

    // ======================================================================================
    // 3. WEBSOCKET CLIENT
    // ======================================================================================

    class WebSocketClient {
        constructor(endpoint, topic, renderer) {
            this.endpoint = endpoint;
            this.topic = topic;
            this.renderer = renderer;
            this.stompClient = null;
        }

        connect() {
            try {
                // 1. Create a SockJS instance for compatibility
                const socket = new SockJS(this.endpoint);
                // 2. Use STOMP over the SockJS connection
                this.stompClient = Stomp.over(socket);
                this.stompClient.debug = null; // Disable STOMP logging in console

                this.stompClient.connect({}, (frame) => {
                    log('WebSocket connection established successfully.', 'info');
                    this.renderer.handleStatusUpdate({
                        isReady: true,
                        message: `Connected to Spring Backend via WebSocket. Waiting for metric push...`
                    });

                    // 3. Subscribe to the destination topic
                    this.stompClient.subscribe(this.topic, (message) => {
                        // The payload comes from MetricsService.java's template.convertAndSend()
                        const data = JSON.parse(message.body);
                        this.renderer.handleMetricUpdate(data);
                    });
                }, (error) => {
                    log('WebSocket connection error. Retrying in 5s. Ensure Spring Boot is running on port 8088.', 'error');
                    this.renderer.handleStatusUpdate({
                        isReady: false,
                        message: `Connection failed. Retrying in 5s...`
                    });
                    setTimeout(() => this.connect(), 5000); // Attempt to reconnect
                });
            } catch (e) {
                log('Fatal error during WebSocket setup: ' + e.message, 'error');
                this.renderer.handleStatusUpdate({
                    isReady: false,
                    message: `Setup error. Check browser console.`
                });
            }
        }
    }

    // ======================================================================================
    // 4. DASHBOARD RENDERER (Frontend Logic)
    // ======================================================================================

    class DashboardRenderer {
        constructor(config) {
            this.config = config;
            this.container = document.getElementById('metrics-container');
            this.statusElement = document.getElementById('status');
            this.configMap = new Map(config.map(item => [item.id, item]));

            this.renderInitialState();
        }

        renderInitialState() {
            this.container.innerHTML = this.config.map(metric => `
                    <div id="card-${metric.id}" class="bg-card-bg p-6 rounded-xl shadow-xl transition duration-300 border-t-4 border-flink-blue">
                        <div class="text-sm font-medium text-gray-400 mb-1">${metric.title}</div>
                        <div class="text-5xl font-extrabold text-white">
                            <span id="value-${metric.id}">${metric.initialValue}</span>
                            <span class="text-xl font-semibold text-gray-400 ml-2" id="unit-${metric.id}">${metric.unit}</span>
                        </div>
                        <div class="text-xs text-gray-500 mt-2 truncate">
                            Job: <span id="jobname-${metric.id}">N/A</span>
                        </div>
                    </div>
                `).join('');
        }

        handleMetricUpdate(data) {
            // Expected Data structure from Java Backend: {id: 'input_rate', value: '0.50', jobName: 'Remittance_Metrics_Job'}
            const metricConfig = this.configMap.get(data.id);
            if (!metricConfig) return;

            const valueEl = document.getElementById(`value-${data.id}`);
            const jobNameEl = document.getElementById(`jobname-${data.id}`);

            if (valueEl) valueEl.textContent = data.value;
            if (jobNameEl && data.jobName) jobNameEl.textContent = data.jobName;

            log(`Metric pushed: ${metricConfig.title} -> ${data.value} ${metricConfig.unit}`, 'info');
        }

        handleStatusUpdate(data) {
            if (data.isReady) {
                this.statusElement.className = 'mt-4 p-2 rounded-lg text-sm font-semibold bg-green-900 text-green-300';
                this.statusElement.textContent = data.message;
            } else {
                this.statusElement.className = 'mt-4 p-2 rounded-lg text-sm font-semibold bg-red-900 text-red-300';
                this.statusElement.textContent = data.message;
            }
        }
    }

    // ======================================================================================
    // 5. APPLICATION INITIALIZATION
    // ======================================================================================

    document.addEventListener('DOMContentLoaded', () => {
        const renderer = new DashboardRenderer(METRICS_CONFIG);
        const client = new WebSocketClient(WEBSOCKET_ENDPOINT, SUBSCRIPTION_TOPIC, renderer);
        client.connect();
    });
</script>
</body>
</html>