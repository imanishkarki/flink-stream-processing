<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Flink Live Metrics Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'flink-blue': '#4c78a0',
                        'bg-dark': '#111827',
                        'card-bg': '#1f2937'
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    <style>
        body { font-family: 'Inter', sans-serif; }
        .metric-card { transition: all 0.3s ease; }
        .metric-card:hover { transform: translateY(-2px); box-shadow: 0 10px 30px rgba(76, 120, 160, 0.3); }
        .pulse { animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: .5; } }
    </style>
</head>
<body class="bg-bg-dark text-gray-100 min-h-screen p-4 sm:p-8">

<div class="max-w-7xl mx-auto">
    <header class="text-center mb-10 pb-4 border-b border-gray-700">
        <h1 class="text-4xl font-extrabold text-white mb-2 tracking-tight">
            <span class="text-flink-blue">Flink</span> Live Streaming Dashboard
        </h1>
        <p class="text-gray-400 text-sm">Real-time monitoring via WebSocket (ws://localhost:8088/metrics-feed)</p>
        <div id="status" class="mt-4 p-2 rounded-lg text-sm font-semibold transition-all duration-300">
            Connecting to WebSocket Backend...
        </div>
    </header>

    <!-- Throughput Section -->
    <section class="mb-8">
        <h2 class="text-2xl font-bold mb-4 text-gray-200 flex items-center">
            <span class="w-2 h-8 bg-flink-blue mr-3 rounded"></span>
            Throughput Metrics
        </h2>
        <div id="throughput-metrics" class="grid grid-cols-1 md:grid-cols-2 gap-6"></div>
    </section>

    <!-- Latency Section -->
    <section class="mb-8">
        <h2 class="text-2xl font-bold mb-4 text-gray-200 flex items-center">
            <span class="w-2 h-8 bg-yellow-500 mr-3 rounded"></span>
            Latency Metrics
        </h2>
        <div id="latency-metrics" class="grid grid-cols-1 md:grid-cols-2 gap-6"></div>
    </section>

    <!-- Checkpoint Section -->
    <section class="mb-8">
        <h2 class="text-2xl font-bold mb-4 text-gray-200 flex items-center">
            <span class="w-2 h-8 bg-green-500 mr-3 rounded"></span>
            Checkpoint Metrics
        </h2>
        <div id="checkpoint-metrics" class="grid grid-cols-1 md:grid-cols-2 gap-6"></div>
    </section>

    <!-- Performance Section -->
    <section class="mb-8">
        <h2 class="text-2xl font-bold mb-4 text-gray-200 flex items-center">
            <span class="w-2 h-8 bg-red-500 mr-3 rounded"></span>
            Performance Metrics
        </h2>
        <div id="performance-metrics" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6"></div>
    </section>

    <!-- Logs -->
    <div class="mt-10">
        <h2 class="text-xl font-semibold mb-3 text-gray-300">Live Event Log</h2>
        <pre id="log" class="bg-gray-800 p-4 rounded-lg text-xs text-gray-300 overflow-x-auto h-48 border border-gray-700"></pre>
    </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.5.1/sockjs.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>

<script>
    const WEBSOCKET_ENDPOINT = 'http://localhost:8088/metrics-feed';
    const SUBSCRIPTION_TOPIC = '/topic/metrics';

    const METRICS_CONFIG = {
        throughput: [
            { id: 'input_rate', title: 'Input Rate', unit: 'rec/s', icon: 'ðŸ“¥', color: 'blue' },
            { id: 'output_rate', title: 'Output Rate', unit: 'rec/s', icon: 'ðŸ“¤', color: 'blue' }
        ],
        latency: [
            { id: 'avg_latency', title: 'Average Latency', unit: 'ms', icon: 'â±ï¸', color: 'yellow' },
            { id: 'max_latency', title: 'Max Latency', unit: 'ms', icon: 'âš ï¸', color: 'yellow' }
        ],
        checkpoint: [
            { id: 'checkpoint_size', title: 'Checkpoint Size', unit: 'MB', icon: 'ðŸ’¾', color: 'green' },
            { id: 'checkpoint_duration', title: 'Checkpoint Duration', unit: 'ms', icon: 'â²ï¸', color: 'green' }
        ],
        performance: [
            { id: 'backpressure', title: 'Backpressure', unit: '%', icon: 'ðŸ”„', color: 'red' },
            { id: 'cpu_usage', title: 'CPU Usage', unit: '%', icon: 'ðŸ’»', color: 'red' },
            { id: 'heap_memory_used', title: 'Heap Used', unit: 'MB', icon: 'ðŸ§ ', color: 'red' },
            { id: 'heap_memory_max', title: 'Heap Max', unit: 'MB', icon: 'ðŸ“Š', color: 'red' }
        ]
    };

    const logElement = document.getElementById('log');

    const log = (message, type = 'info') => {
        const timestamp = new Date().toLocaleTimeString();
        const prefix = type === 'error' ? 'ERROR' : (type === 'warn' ? 'WARN' : 'INFO');
        logElement.textContent += `[${timestamp}] [${prefix}] ${message}\n`;
        logElement.scrollTop = logElement.scrollHeight;
    }

    class WebSocketClient {
        constructor(endpoint, topic, renderer) {
            this.endpoint = endpoint;
            this.topic = topic;
            this.renderer = renderer;
            this.stompClient = null;
        }

        connect() {
            try {
                const socket = new SockJS(this.endpoint);
                this.stompClient = Stomp.over(socket);
                this.stompClient.debug = null;

                this.stompClient.connect({}, (frame) => {
                    log('WebSocket connection established successfully.', 'info');
                    this.renderer.handleStatusUpdate({
                        isReady: true,
                        message: `âœ“ Connected - Receiving live metrics`
                    });

                    this.stompClient.subscribe(this.topic, (message) => {
                        const data = JSON.parse(message.body);
                        this.renderer.handleMetricUpdate(data);
                    });
                }, (error) => {
                    log('WebSocket connection error. Retrying in 5s...', 'error');
                    this.renderer.handleStatusUpdate({
                        isReady: false,
                        message: `âœ— Connection failed. Retrying...`
                    });
                    setTimeout(() => this.connect(), 5000);
                });
            } catch (e) {
                log('Fatal error during WebSocket setup: ' + e.message, 'error');
            }
        }
    }

    class DashboardRenderer {
        constructor(config) {
            this.config = config;
            this.statusElement = document.getElementById('status');
            this.configMap = new Map();

            this.renderInitialState();
        }

        renderInitialState() {
            Object.entries(this.config).forEach(([section, metrics]) => {
                const container = document.getElementById(`${section}-metrics`);
                if (!container) return;

                container.innerHTML = metrics.map(metric => {
                    this.configMap.set(metric.id, metric);
                    return this.createMetricCard(metric);
                }).join('');
            });
        }

        createMetricCard(metric) {
            const borderColor = {
                blue: 'border-flink-blue',
                yellow: 'border-yellow-500',
                green: 'border-green-500',
                red: 'border-red-500'
            }[metric.color] || 'border-flink-blue';

            return `
                <div id="card-${metric.id}" class="metric-card bg-card-bg p-6 rounded-xl shadow-xl border-t-4 ${borderColor}">
                    <div class="flex items-center justify-between mb-2">
                        <div class="text-sm font-medium text-gray-400">${metric.title}</div>
                        <span class="text-2xl">${metric.icon}</span>
                    </div>
                    <div class="text-4xl font-extrabold text-white mb-1">
                        <span id="value-${metric.id}" class="pulse">--</span>
                        <span class="text-lg font-semibold text-gray-400 ml-2">${metric.unit}</span>
                    </div>
                    <div class="text-xs text-gray-500 mt-2 truncate">
                        Job: <span id="jobname-${metric.id}">Waiting...</span>
                    </div>
                </div>
            `;
        }

        handleMetricUpdate(data) {
            const metricConfig = this.configMap.get(data.id);
            if (!metricConfig) return;

            const valueEl = document.getElementById(`value-${data.id}`);
            const jobNameEl = document.getElementById(`jobname-${data.id}`);

            if (valueEl) {
                valueEl.textContent = data.value;
                valueEl.classList.remove('pulse');
            }
            if (jobNameEl && data.jobName) jobNameEl.textContent = data.jobName;

            log(`${metricConfig.title}: ${data.value} ${metricConfig.unit}`, 'info');
        }

        handleStatusUpdate(data) {
            if (data.isReady) {
                this.statusElement.className = 'mt-4 p-2 rounded-lg text-sm font-semibold bg-green-900 text-green-300';
                this.statusElement.textContent = data.message;
            } else {
                this.statusElement.className = 'mt-4 p-2 rounded-lg text-sm font-semibold bg-red-900 text-red-300';
                this.statusElement.textContent = data.message;
            }
        }
    }

    document.addEventListener('DOMContentLoaded', () => {
        const renderer = new DashboardRenderer(METRICS_CONFIG);
        const client = new WebSocketClient(WEBSOCKET_ENDPOINT, SUBSCRIPTION_TOPIC, renderer);
        client.connect();
    });
</script>
</body>
</html>